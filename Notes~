Notes package piwik

Pour le moment rien n'est fait:

Reste à faire:
manifest.json
scripts/
	install
	remove
	upgrade
conf/nginx.conf




Notes d'installation:
	On dirait qu'il n'y pas que la webinstall...
		Donc curl en pagaille!
			sudo chown -R www-data:www-data /var/www/webapp_mcrudelis/testapp
			sudo chmod -R 0755 /var/www/webapp_mcrudelis/testapp/tmp
			On commence à la page index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https
		Il y a un choix de langue ici, on verra après.
				Les champs à renseigner sont:
					host (host-0) -> localhost ou laisser 127.0.0.1
					username (username-0) -> piwik
					password (password-0) -> 9T2xzvJvK8MPKHFS
					dbname (dbname-0) -> piwik
					tables_prefix (tables_prefix-0) -> piwik_
					adapter (adapter-0) -> PDO\MYSQL

			On enchaine ensuite avec index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation
				Les champs à renseigner sont:
					login (login-0) -> mcrudelis
					password (password-0) -> mdp admin (même que bdd) (avec un peu de chance, il sautera avec ldap!?) 9T2xzvJvK8MPKHFS
					password_bis (password_bis-0) -> mdp admin (même que bdd) 9T2xzvJvK8MPKHFS
					email (email-0) -> email admin, je sais pas comment obtenir ça. root@crudelis-test.fr
					subscribe_newsletter_piwikorg (subscribe_newsletter_piwikorg-0) -> 0
					subscribe_newsletter_piwikpro (subscribe_newsletter_piwikpro-0) -> 0

			index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation
				Les champs à renseigner sont:
					siteName (siteName-0) -> crudelis-test.fr
					url (url-0) -> https://crudelis-test.fr
					timezone (timezone-0) -> Il faut trouver l'info sur la machine, chaud! Ville ou UTC
					ecommerce (ecommerce-0) -> 0

			On peut éventuellement terminer avec
			https://crudelis-test.fr/testapp/index.php?action=finished&trackerStatus=500&clientProtocol=https&module=Installation&site_idSite=1&site_name=crudelis-test.fr

Soit en curl:
curl -kvL --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https
curl -kvL --data "login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0" https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation
curl -kvL --data "siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0" https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation

Ça bloque sur
* SSLv3, TLS alert, Client hello (1):
En fait, il enchaine sur la page d'après directement!

Par contre, la bdd est remplie, donc la première commande passe bien.
L'user est bien là aussi. Avec son mdp.
-> La langue n'est pas choisie.
-> Le site n'est pas ajouté. Et je ne sais pas où trouver la mention des newsletters.
	Ça coince par là.
		Peut-être Paris, qui correspond à Europe/Paris. (Modifié)
Ok, c'était juste ça, il fallait Europe/Paris et ça fonctionne.

Reste le problème que la connection reste en attente, ce qui est bloquant.

Voir:
-:, --next
--connect-timeout <seconds>
Tenter l'ancienne méthode de leed,
curl -k "adresse?commande"
curl -kvL "https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https&host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL"
C'est mieux! Il n'attend pas à la fin!
curl -kvL "https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation&login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0"
curl -kvL "https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation&siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0"

Mais là ça ne fonctionne pas, cookies peut-être? Étudier ça en détail...
A la première commande, la bdd n'est pas créée. La commande ainsi formée ne fonctionne donc pas.

Retour aux premières commandes:

curl -kvL --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https
curl -kvL --data "login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0" https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation
curl -kvL --data "siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0" https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation


-:, --next
Test avec next:
curl -kvL --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https --next --data "login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0" https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation --next --data "siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0" https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation
Non, ça bloque à 43%, il essaye de supprimer les bdd.

--connect-timeout <seconds>
Test en time-out:
curl -kvL --connect-timeout 2 --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https --next https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https
curl -kvL --data "login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0" https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation --connect-timeout 2
curl -kvL --data "siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0" https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation --connect-timeout 2

curl -kvL --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" https://crudelis-test.fr/testapp/index.php?action=databaseSetup&clientProtocol=https --next https://crudelis-test.fr/testapp/index.php?action=databaseSetup&clientProtocol=https&submit=1
... Rien à faire, il créer bien la bdd, mais curl ne s'arrête pas. Il faut que ce putain de process se termine!

il faudra peut-être des cookies?
L nécessaire?

Bon, une idée peut être serait de suivre toutes les étapes pour satisafaires piwik. Avec des next.
Page 3
curl -kvL --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https
Page 4
curl -kvL https://crudelis-test.fr/testapp/index.php?action=tablesCreation&trackerStatus=500&clientProtocol=https&module=Installation
Page 5
curl -kvL --data "login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0" https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation
Page 6
curl -kvL --data "siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0" https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation
Page 7
curl -kvL https://crudelis-test.fr/testapp/index.php?action=trackingCode&trackerStatus=500&clientProtocol=https&module=Installation&site_idSite=1&site_name=crudelis-test.fr
Page 8
curl -kvL https://crudelis-test.fr/testapp/index.php?action=finished&trackerStatus=500&clientProtocol=https&module=Installation&site_idSite=1&site_name=crudelis-test.fr
Fin
curl -kvL https://crudelis-test.fr/testapp/index.php

Scripts:
touch script; chmod +x script; nano script

#!/bin/bash
curl -kvL --data "host=localhost&username=piwik&password=9T2xzvJvK8MPKHFS&dbname=piwik&tables_prefix=piwik_&adapter=PDO\\MYSQL" "https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https"
echo "phase 1 ok"
curl -kvL --data "login=mcrudelis&password=9T2xzvJvK8MPKHFS&password_bis=9T2xzvJvK8MPKHFS&email=root@crudelis-test.fr&subscribe_newsletter_piwikorg=0&subscribe_newsletter_piwikpro=0" "https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation"
echo "phase 2 ok"
curl -kvL --data "siteName=crudelis-test.fr&url=https://crudelis-test.fr&timezone=Europe/Paris&ecommerce=0" "https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation"
echo "phase 3 ok"
echo "fin"

Décomposé: (test)
#!/bin/bash
curl -kL -d host="localhost" -d username="piwik" -d password="9T2xzvJvK8MPKHFS" -d dbname="piwik" -d tables_prefix="piwik_" -d adapter="PDO\\MYSQL" "https://crudelis-test.fr/testapp/index.php?action=databaseSetup&trackerStatus=500&clientProtocol=https"
echo "phase 1 ok"
curl -kL -d login="mcrudelis" -d password="9T2xzvJvK8MPKHFS" -d password_bis="9T2xzvJvK8MPKHFS" -d email="root@crudelis-test.fr" -d subscribe_newsletter_piwikorg="0" -d subscribe_newsletter_piwikpro="0" "https://crudelis-test.fr/testapp/index.php?action=setupSuperUser&trackerStatus=500&clientProtocol=https&module=Installation"
echo "phase 2 ok"
curl -kL -d siteName="crudelis-test.fr" -d url="https://crudelis-test.fr" -d timezone="Europe/Paris" -d ecommerce="0" "https://crudelis-test.fr/testapp/index.php?action=firstWebsiteSetup&trackerStatus=500&clientProtocol=https&module=Installation"
echo "phase 3 ok"
echo "fin"

Ça fonctionne!!!



Instal de base déjà.
	OK

mdp dump
CRiXj3H8qFDnWymihQaDywpz

ldap:
	Plugin LoginLdap
	Il faut trouver la config ldap! Pas dans la bdd (c'est déjà bien!)
		config/config.ini.php
			[LoginLdap]
			serverUrl = "ldap://localhost/"
			ldapPort = 389
			baseDn = "dc=yunohost,dc=org"
			userIdField = "uid"
			mailField = "mail"
			aliasField = "cn"
			usernameSuffix = ""
			adminUser = ""
			adminPass = ""
			memberOf = ""
			filter = "(objectClass=person)"
			useKerberos = "false"
			debugEnabled = "false"
			autoCreateUser = "true"

Il refuse l'user mcrudelis car il existe déjà, admin à l'install.
On va utiliser un compte admin à la con.
admin: adminadmin

On suppr le compte mcrudelis. Puis on l'ajoute avec ldap.
Ok, mais compte sans droits.
	Ça se passe en bdd ça... dans piwik_user.

Certes, mais j'ai ajouté l'user depuis l'interface. Il faut que ce soit automatique!
Il va falloir utiliser le plugin manuellement je pense...

Dans le log du plugin, il se passe ça:
	2014-08-26 22:01:40: INFO: ldapfunctions getUserEntries(mcrudelis) - ldap_bind: 
	2014-08-26 22:01:40: INFO: ldapfunctions getUserEntries(mcrudelis) - ldap_search: (&(objectClass=person)(uid=mcrudelis))
	2014-08-26 22:01:40: INFO: ldapfunctions getUserEntries(mcrudelis) - ldap_get_entries(); count: 1
	2014-08-26 22:01:40: INFO: ldapfunctions close() - ldap connection closed

ldapfunctions getUserEntries() est dans le fichier LdapFunctions.php
Il faudra surement faire du php5-cli, hors ce paquet doit être installé pour le script python des log.

	Cette fonction semble uniquement chercher l'user, rien de plus.
	Il faut trouver d'où vient l'appel!
		Le controller.php semble intéressant! L'ajout d'user se fait là!
			private function addUserLdap($userLogin)
Il nous faut php5-cli

php -r 'define("PIWIK_INCLUDE_PATH","/var/www/piwik");'
php -f Controller.php --rclass Controller -d userLogin=mcrudelis


	J'ai le sentiment que le plus simple serait encore de créer un petit bout de code php pour l'exécuter direct en cli. Celui appelant la fonction qui nous intéresse
		Putain, ça me gonfle php! On va passer par curl, là je vais péter un cable sinon!
		Faut voir aussi ldap en cli! Non allez, en cli, ya plusieurs truc en bdd, je suis pas sûr.

	La page qui nous intéresse:
		https://crudelis-test.fr/piwik/index.php?module=LoginLdap&action=admin
			champs username
			submit pour valider
				curl -kLv -d username="mcrudelis" "https://crudelis-test.fr/piwik/index.php?module=LoginLdap&action=admin"
Il faut se loguer avant
				curl -kLv -b cookies.txt -c cookies.txt -d login_form_login="admin" -d login_form_password="adminadmin" "https://crudelis-test.fr/piwik/index.php?login_form"
				curl -kLv -b cookies.txt -c cookies.txt --user admin:adminadmin "https://crudelis-test.fr/piwik/index.php"

curl -kLv -b cookies.txt -c cookies.txt --data "login_form_login=admin&login_form_password=adminadmin" "https://crudelis-test.fr/piwik"

curl -kLv -b cookies.txt -c cookies.txt "https://crudelis-test.fr/piwik?login_form_login=admin&login_form_password=adminadmin"


curl -kLv -b cookies.txt -c cookies.txt -d username="mcrudelis" "https://crudelis-test.fr/piwik/index.php?module=LoginLdap&action=admin"

Je n'arrive pas à me connecter!!!
l'ajout d'un user ldap fait quoi?
	Il m'ajoute le mdp crypté, le login, l'alias, l'email et un token_auth! et une date.
On va le tenter manuellement pour voir!?
login mcrudelis
pass cf04bdd6d85d8adb46f2434038abf4cf
	 87cf4ae009f8bb17a0a7abfdc79f07eb
alias Maniack Crudelis
email maniack@crudelis-test.fr
token 7d002d3dd55ab4c02ed50b43263fa56c
	  4ddd8613f7a2ca0c0645b1c1d6ed88d8
date 2014-08-27 19:26:27
INSERT INTO `piwik`.`piwik_user` (`login`, `password`, `alias`, `email`, `token_auth`, `superuser_access`, `date_registered`) VALUES ('mcrudelis', 'cf04bdd6d85d8adb46f2434038abf4cf', 'Maniack Crudelis', 'maniack@crudelis-test.fr', '', '1', '2014-08-27 19:26:27')

En passant direct par la bdd, ça ne fonctionne pas! SI, ça fonctionne très bien.
Mais il faut choper les infos de ldap:

login
mdp hasché
alias
email

Affiche tout:
ldapsearch -x -h localhost -b "dc=yunohost,dc=org"

Sauf que... ya pas de mot de passe! Putain c'est la merde...!
Et le plugin ldap génère un mot de passe obscur sorti d'on ne sais où... Qui fonctionne pourtant. Je pige rien.



On peut tenter quelque chose avec le LoginHttpAuth et un fichier pour le login/mdp de l'user admin:adminadmin
Ainsi on pourrait peut-être passer en curl.

curl -kLv -c cookies.txt --user admin:adminadmin "https://crudelis-test.fr/piwik"
curl -kLv -b cookies.txt -d username="mcrudelis" "https://crudelis-test.fr/piwik/index.php?module=LoginLdap&action=admin"

Avec le cookies, il n'accepte pas la connexion. On va tenter en une seule ligne!
curl -kLv --user admin:adminadmin -d username="mcrudelis" "https://crudelis-test.fr/piwik/index.php?module=LoginLdap&action=admin"

Il se connecte, arrive sur la bonne page, mais ne fait rien.
	<form method="post" action="?module=LoginLdap&amp;action=loadUser&amp;form=loadUserForm&amp;token_auth=af2a9e342cf4c662c9999d0e05819b13"
On va tenter sans le token évidemment!
curl -kLv --user admin:adminadmin -d username="mcrudelis" "https://crudelis-test.fr/piwik/index.php?module=LoginLdap&action=loadUser&form=loadUserForm"

OUI!

En revanche, on se connecte avec une erreur car on a aucun droit lors de connection.

Ça se change facilement en bdd.
UPDATE `piwik`.`piwik_user` SET `superuser_access` = '1' WHERE `piwik_user`.`login` = 'mcrudelis';

extrait leed:
mysql -h localhost -u $db_user -p$db_pwd -s $db_user -e 'SELECT value FROM leed_configuration WHERE `key`="synchronisationCode"' | sed -n 1p)

mysql -h localhost -u piwik -pCRiXj3H8qFDnWymihQaDywpz -s piwik -e "UPDATE piwik.piwik_user SET superuser_access = '1' WHERE piwik_user.login = \"mcrudelis\""
Nous permet de passer le droit user à 1!
Une fois cela fait, on vire l'user admin qui servait qu'à ça!
mysql -h localhost -u piwik -pCRiXj3H8qFDnWymihQaDywpz -s piwik -e "DELETE FROM piwik.piwik_user WHERE piwik_user.login = 'admin'"


OK!!!
Donc, en principe, ldap ok, http auth ok, admin mcrudelis ok.
Par contre, impossible de se déco!
Et impossible de se connecter sans passer par le SSO. (Je sais pas si le script va apprécier!)
Test:
./import_logs.py --url=https://crudelis-test.fr/piwik log.log --idsite=1 -d
Il semblerait que ça ne lui pose aucun problème!



On pourra changer des options de bases (définie dans global.ini.php) en les ajoutant à config.ini.php)

sudo yunohost app install piwik_ynh
